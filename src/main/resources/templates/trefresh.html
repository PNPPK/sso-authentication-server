<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1.0" name="viewport">
    <script th:src="@{/js/fingerprint2.min.js}"></script>
    <link th:href="@{/favicon.ico}" rel="icon">
    <title>Authentication server</title>
</head>
<body>
<noscript>
    <strong>We're sorry but this app doesn't work properly without JavaScript enabled. Please enable it to
        continue.</strong>
</noscript>
<form action="#" id="refresh_form" method="post" th:action="@{/api/refresh}">
    <input id="fp_input" name="_fingerprint" type="hidden" value="FP_PLACEHOLDER">
    <input th:if="${param.continue != null}" name="_continue" type="hidden" th:value="${param.continue}">
</form>
<script>
     let refresh = function() {
        let p = new Promise((resolve, reject) => {
            async function getHash () {
                const options = {
                    excludes: {
                        plugins: true,
                        localStorage: true,
                        adBlock: true,
                        screenResolution: true,
                        availableScreenResolution: true,
                        enumerateDevices: true,
                        pixelRatio: true,
                        doNotTrack: true
                    }
                }

                try {
                    const components = await Fingerprint2.getPromise(options);
                    const values = components.map(component => component.value);
                    return String(Fingerprint2.x64hash128(values.join(''), 31));
                } catch (e) {
                    reject(e);
                }
            }

            if (window.requestIdleCallback) {
                requestIdleCallback(async () => resolve(await getHash()));
            } else {
                setTimeout(async () => resolve(await getHash()), 500);
            }
        });

        p.then(result => {
            document.getElementById('fp_input').value = result;
            document.getElementById('refresh_form').submit();
        });
    }
    refresh();
</script>
</body>
</html>